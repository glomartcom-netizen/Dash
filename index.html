<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DimeX Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
<script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

<style>
*{box-sizing:border-box}
body{
margin:0;
font-family:Poppins;
background:#000;
color:#fff;
}

.topbar{
display:flex;
justify-content:space-between;
align-items:center;
padding:18px 25px;
background:#0b0b0b;
border-bottom:1px solid #222;
}

.logoWrap{
display:flex;
align-items:center;
gap:12px;
}

.logoWrap img{width:45px}

.logoText{
color:gold;
font-size:22px;
font-weight:600;
letter-spacing:1px;
}

.connectBtn{
background:linear-gradient(90deg,#ffd700,#ffb700);
color:#000;
border:none;
padding:12px 22px;
border-radius:10px;
font-weight:bold;
cursor:pointer;
font-size:14px;
}

.container{
max-width:1250px;
margin:auto;
padding:30px 20px;
}

#walletDisplay{
margin-bottom:20px;
color:gold;
font-size:14px;
}
  
/* ===== STATS HORIZONTAL STYLE ===== */

.statsSingle{
  display:flex;
  flex-direction:column;
  gap:14px;
  margin-bottom:30px;
}

.statRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#111;
  border:1px solid rgba(255,215,0,0.35);
  border-radius:14px;
  padding:16px 20px;
}

.statLeft{
  display:flex;
  align-items:center;
  gap:12px;
}

.statLeft i{
  color:gold;
  font-size:18px;
}

.statName{
  color:#ccc;
  font-weight:500;
}

.statAmount{
  color:gold;
  font-weight:600;
  font-size:16px;
}

.grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:25px;
margin-bottom:30px;
}

.card{
background:#111;
border:1px solid rgba(255,215,0,0.35);
padding:28px;
border-radius:18px;
}

h3{
margin-top:0;
color:gold;
font-weight:600;
}

h3 i{
  margin-right:8px;
  color:gold;
}
  
input,select{
width:100%;
padding:14px;
background:#000;
border:1px solid #333;
color:#fff;
border-radius:10px;
margin-top:12px;
font-size:14px;
}

button{
padding:14px;
border:none;
border-radius:10px;
background:gold;
font-weight:bold;
cursor:pointer;
width:100%;
margin-top:14px;
font-size:14px;
}

button:disabled{
opacity:0.6;
cursor:not-allowed;
}

.contractRow{
display:flex;
justify-content:space-between;
align-items:center;
background:#000;
padding:14px;
margin:10px 0;
border-radius:10px;
border:1px solid #222;
}

.contractRow button{
width:auto;
padding:8px 16px;
margin:0;
}

.popup{
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.85);
display:none;
align-items:center;
justify-content:center;
z-index:9999;
}

.popupBox{
background:#111;
padding:30px;
border-radius:18px;
width:92%;
max-width:550px;
max-height:80vh;
overflow:auto;
border:1px solid #222;
}

.adminPanel{display:none;margin-top:20px}

/* ================= MOBILE RESPONSIVE ================= */

@media(max-width:600px){

  .logoWrap img{
    width:32px;
  }

  .logoText{
    font-size:18px;
  }

  /* Cards single column */
  .grid{
    grid-template-columns:1fr;
    gap:15px;
  }

  /* Smaller cards */
  .card{
    padding:16px;
    border-radius:14px;
  }

  input,select{
    padding:10px;
    font-size:13px;
  }

  button{
    padding:12px;
    font-size:13px;
  }

}

@media(max-width:480px){

  .statRow{
    padding:12px 14px;
  }

  .statName{
    font-size:13px;
  }

  .statAmount{
    font-size:14px;
  }

}
</style>
</head>

<body>

<div class="topbar">
<div class="logoWrap">
<img src="https://i.ibb.co/HpqwGFqt/logo.png">
<div class="logoText">DimeX Dashboard</div>
</div>
<button class="connectBtn" onclick="connectWallet()">Connect Wallet</button>
</div>

<div class="container">

<div id="walletDisplay"></div>
<div id="status" style="margin-bottom:15px;color:gold;"></div>  

<div class="statsSingle">

<div class="statRow">
  <div class="statLeft">
    <i class="fa-solid fa-wallet"></i>
    <span class="statName">Total Stake</span>
  </div>
  <div class="statAmount" id="totalStake">0 DMX</div>
</div>

<div class="statRow">
  <div class="statLeft">
    <i class="fa-solid fa-bolt"></i>
    <span class="statName">Daily Reward</span>
  </div>
  <div class="statAmount" id="dailyReward">0 DMX</div>
</div>

<div class="statRow">
  <div class="statLeft">
    <i class="fa-solid fa-chart-line"></i>
    <span class="statName">Total Earned</span>
  </div>
  <div class="statAmount" id="totalEarned">0 DMX</div>
</div>

<div class="statRow">
  <div class="statLeft">
    <i class="fa-solid fa-user-plus"></i>
    <span class="statName">Direct Income</span>
  </div>
  <div class="statAmount" id="directIncome">0 DMX</div>
</div>

<div class="statRow">
  <div class="statLeft">
    <i class="fa-solid fa-sitemap"></i>
    <span class="statName">Level Income</span>
  </div>
  <div class="statAmount" id="levelIncome">0 DMX</div>
</div>

<div class="statRow">
  <div class="statLeft">
    <i class="fa-solid fa-users"></i>
    <span class="statName">Team Volume</span>
  </div>
  <div class="statAmount" id="teamVolume">0 DMX</div>
</div>

<div class="statRow">
  <div class="statLeft">
    <i class="fa-solid fa-chart-simple"></i>
    <span class="statName">Direct Volume</span>
  </div>
  <div class="statAmount" id="directVolume">0 DMX</div>
</div>

<div class="statRow">
  <div class="statLeft">
    <i class="fa-solid fa-layer-group"></i>
    <span class="statName">Level Unlock Remaining</span>
  </div>
  <div class="statAmount" id="levelUnlockRemaining">0 Days</div>
</div>

<div class="grid">

<div class="card">
<h3><i class="fa-solid fa-coins"></i> Stake</h3>
<select id="token">
<option value="USDT">USDT BEP20</option>
<option value="DMX">DMX</option>
</select>
<input id="amount" placeholder="Enter amount">
<select id="duration">
<option value="" disabled selected>Select Duration</option>
<option value="90">90 Days (0.20%)</option>
<option value="180">180 Days (0.25%)</option>
<option value="365">365 Days (0.30%)</option>
</select>
<button id="approveBtn" onclick="approveToken()">Approve</button>
<button id="stakeBtn" onclick="stakeToken()">Stake</button>
</div>
  
<div class="card">
<h3><i class="fa-solid fa-gift"></i> Claim</h3>
<input id="claimable" readonly>
  
<button id="claimBtn" onclick="claim()">Claim</button>
<button id="restakeBtn" onclick="restake()">Restake</button>
</div>

<div class="card">
<h3><i class="fa-solid fa-link"></i> Referral</h3>
<input id="refLink" readonly>
<button onclick="copyRef()">Copy Link</button>
</div>

<div class="card">
<h3><i class="fa-solid fa-sitemap"></i> Team</h3>
<button onclick="openDownline()">View Downline</button>
<button onclick="openHistory()">Claim History</button>
<button onclick="openStakeHistory()">Stake History</button> 
</div>

</div>

<div class="card">
<h3><i class="fa-solid fa-network-wired"></i> Ecosystem</h3>
  
 <div style="margin-bottom:15px;font-size:14px;color:#aaa;">
ðŸ”¥ Live DMX Price:
<span id="livePriceUser" style="color:gold;">--</span><br>
Mode:
<span id="priceModeUser" style="color:gold;">--</span>
 </div> 
  
<div class="contractRow"><span>DMX Token</span><button onclick="viewAddress(DMX)">View</button></div>
<div class="contractRow"><span>Staking</span><button onclick="viewAddress(STAKING_ADDRESS)">View</button></div>
<div class="contractRow"><span>LP Pair</span><button onclick="viewAddress(LP)">View</button></div>
<div class="contractRow"><span>Router</span><button onclick="viewAddress(ROUTER)">View</button></div>
</div>
  
<!-- ================= ADMIN PANEL START ================= -->
<div class="adminPanel" id="adminPanel">
  <div class="card">

    <div style="
      background:#111;
      border:1px solid gold;
      padding:8px 12px;
      border-radius:8px;
      margin-bottom:15px;
      color:gold;
      font-size:13px;">
      âœ” Admin Wallet Connected
    </div>

    <h3>
      <i class="fa-solid fa-user-shield"></i>
      Full Admin Control Panel
    </h3>

<!-- ðŸ”¥ LIVE PRICE DISPLAY -->
<div style="margin-bottom:15px;color:#aaa;font-size:14px;">
ðŸ”¥ Current DMX Price:
<span id="livePriceAdmin" style="color:gold;">--</span><br>
Mode:
<span id="priceModeAdmin" style="color:gold;">--</span>
</div>
    
    <!-- Pause -->
    <button onclick="pauseStaking()">Pause Staking</button>
    <button onclick="unpauseStaking()">Unpause Staking</button>

    <hr style="margin:20px 0;border-color:#333;">

    <!-- ===== PLAN REWARD RATES ===== -->
    <h4 style="color:gold;">Plan Reward Rates</h4>

    <div>
      90 Days Current: <span id="rate90" style="color:gold;">--</span>
    </div>
    <input id="rateInput90" placeholder="New % for 90 Days">
    <button onclick="updatePlanRate(90)">Update 90 Days</button>

    <hr style="margin:15px 0;border-color:#222;">

    <div>
      180 Days Current: <span id="rate180" style="color:gold;">--</span>
    </div>
    <input id="rateInput180" placeholder="New % for 180 Days">
    <button onclick="updatePlanRate(180)">Update 180 Days</button>

    <hr style="margin:15px 0;border-color:#222;">

    <div>
      365 Days Current: <span id="rate365" style="color:gold;">--</span>
    </div>
    <input id="rateInput365" placeholder="New % for 365 Days">
    <button onclick="updatePlanRate(365)">Update 365 Days</button>

    <hr style="margin:20px 0;border-color:#333;">

    <!-- Minimum Stake -->
    <h4 style="color:gold;">Update Minimum Stake</h4>
    <input id="minUSDT" placeholder="New Minimum USDT">
    <button onclick="updateMinUSDT()">Update USDT</button>

    <input id="minDMX" placeholder="New Minimum DMX">
    <button onclick="updateMinDMX()">Update DMX</button>

    <hr style="margin:20px 0;border-color:#333;">

    <!-- Emergency Withdraw -->
    <h4 style="color:gold;">Emergency Withdraw</h4>
    <select id="withdrawToken">
      <option value="USDT">USDT</option>
      <option value="DMX">DMX</option>
    </select>
    <input id="withdrawAmount" placeholder="Amount">
    <button onclick="emergencyWithdraw()">Withdraw</button>

    <hr style="margin:20px 0;border-color:#333;">

    <!-- Treasury -->
    <h4 style="color:gold;">Change Treasury Wallet</h4>
    <input id="newTreasury" placeholder="New Treasury Address">
    <button onclick="updateTreasury()">Update Treasury</button>

    <hr style="margin:20px 0;border-color:#333;">

    <!-- Ownership -->
    <h4 style="color:gold;">Transfer Ownership</h4>
    <input id="newOwner" placeholder="New Owner Address">
    <button onclick="transferOwner()">Transfer Ownership</button>

    <hr style="margin:20px 0;border-color:#333;">

    <!-- Direct & Level -->
    <h4 style="color:gold;">Update Direct Bonus %</h4>
    <input id="directPercent" placeholder="New Direct Percent">
    <button onclick="updateDirect()">Update Direct</button>

    <h4 style="color:gold;margin-top:15px;">Update Level Bonus %</h4>
    <input id="levelNumber" placeholder="Level (1-25)">
    <input id="levelPercent" placeholder="New Percent">
    <button onclick="updateLevel()">Update Level</button>

    <hr style="margin:20px 0;border-color:#333;">

    <!-- DMX Price -->
    <h4 style="color:gold;">DMX Price Control</h4>
    <input id="manualPrice" placeholder="DMX price in USDT (0.25)">
    <button onclick="setManualPrice()">Set Manual Price</button>

    <select id="priceMode">
      <option value="true">Enable Manual Price</option>
      <option value="false">Use Live Pancake Price</option>
    </select>
    <button onclick="togglePriceMode()">Update Price Mode</button>

  </div>
</div>
<!-- ================= ADMIN PANEL END ================= -->
  
<div class="popup" id="downlinePopup">
<div class="popupBox">
<h3>Downline History</h3>
<div id="downlineData"></div>
<button onclick="closePopup()">Close</button>
</div>
</div>

<div class="popup" id="historyPopup">
<div class="popupBox">
<h3>Claim History</h3>
<div id="historyData"></div>
<button onclick="closePopup()">Close</button>
</div>
</div>

 <div class="popup" id="stakeHistoryPopup">
  <div class="popupBox">
    <h3>Stake History</h3>
    <div id="stakeHistoryData"></div>
    <button onclick="closePopup()">Close</button>
  </div>
 </div> 

<script>

let provider, signer, userAddress;

const ADMIN="0x53ba2d865be750d0e2d4d01bcb0a46ec1684c46b";
const USDT="0x55d398326f99059fF775485246999027B3197955";
const DMX="PUT_DMX_TOKEN";
const STAKING_ADDRESS="PUT_STAKING_CONTRACT";
const LP="PUT_LP_ADDRESS";
const ROUTER="0x10ED43C718714eb63d5aA57B78B54704E256024E";

const ERC20_ABI=[
  "function approve(address,uint256) external returns(bool)"
];

const STAKE_ABI = [

  // ===== USER =====
  "function stakeUSDT(uint256,uint256,address) external",
  "function stakeDMX(uint256,uint256,address) external",
  "function claim() external",
  "function restake() external",

  // ===== USER VIEW FUNCTIONS =====
  "function totalStakeOf(address) view returns(uint256)",
  "function dailyRewardOf(address) view returns(uint256)",
  "function totalEarnedOf(address) view returns(uint256)",
  "function directIncomeOf(address) view returns(uint256)",
  "function levelIncomeOf(address) view returns(uint256)",
  "function teamVolumeOf(address) view returns(uint256)",
  "function directVolume(address) view returns(uint256)",  

  // ===== PRICE SYSTEM =====
  "function getDMXPrice() view returns(uint256)",
  "function manualPriceEnabled() view returns(bool)",
  "function setManualPrice(uint256) external",
  "function toggleManualPrice(bool) external",

  // ===== ADMIN CONTROL =====
  "function pauseStaking() external",
  "function unpauseStaking() external",

  // ===== REWARD RATE =====
  "function setRewardRate(uint256,uint256) external",
  "function rewardRates(uint256) view returns(uint256)",

  // ===== MINIMUM =====
  "function setMinimumUSDT(uint256) external",
  "function setMinimumDMX(uint256) external",

  // ===== EMERGENCY =====
  "function emergencyWithdrawToken(address,uint256) external",

  // ===== TREASURY & OWNERSHIP =====
  "function setTreasury(address) external",
  "function transferOwnership(address) external",

  // ===== REFERRAL SYSTEM =====
  "function setDirectPercent(uint256) external",
  "function setLevelPercent(uint256,uint256) external",
  "function getLevelCount(address,uint256) view returns(uint256)",
  "function getLevelUsers(address,uint256) view returns((address,uint256,uint256)[])",

  // ===== USER INFO =====
  "function getUserInfo(address) view returns(uint256,uint256,uint256,uint256,uint256,uint256)",
  "function getClaimable(address) view returns(uint256)",
  "function getUnlockTime(address) view returns(uint256)",
  "function getLevelUnlockExpiry(address) view returns(uint256)",
  "function getStakeCount(address) view returns(uint256)",
  "function getStakeInfo(address,uint256) view returns(uint256,uint256,uint256)",

  // ===== EVENTS =====
  "event Claimed(address indexed user,uint256 amount,uint256 time)",
  "event Staked(address indexed user,uint256 amount,uint256 start,uint256 end)"
];
  
function disable(id,state){document.getElementById(id).disabled=state;}
function seconds(d){return Number(d)*86400;}

async function connectWallet(){
try{
if(window.ethereum){
provider=new ethers.providers.Web3Provider(window.ethereum);
await provider.send("eth_requestAccounts",[]);
}else{
const wc=new WalletConnectProvider.default({rpc:{56:"https://bsc-dataseed.binance.org/"}});
await wc.enable();
provider=new ethers.providers.Web3Provider(wc);
}
const network=await provider.getNetwork();
if(network.chainId!==56){alert("Switch to BSC Mainnet");return;}
signer=provider.getSigner();
userAddress=await signer.getAddress();

document.getElementById("walletDisplay").innerHTML="Connected: "+userAddress;
document.getElementById("refLink").value=window.location.origin+"?ref="+userAddress;

if(userAddress.toLowerCase() === ADMIN.toLowerCase()){
  document.getElementById("adminPanel").style.display = "block";
  await loadRates();   // ðŸ”¥ important
}

await loadData();
await loadLivePrice();
setInterval(loadLivePrice,10000);

}catch(e){alert(e.message);}
}

async function loadData(){
try{

  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, provider);

  const info = await c.getUserInfo(userAddress);
  const claimable = await c.getClaimable(userAddress);

  const levelUnlock = await c.getLevelUnlockExpiry(userAddress);
updateLevelUnlockTimer(levelUnlock); // level
  
  // ðŸ”¥ Direct Volume
  const directVol = await c.directVolume(userAddress);

document.getElementById("totalStake").innerHTML =
  ethers.utils.formatUnits(info[0],18) + " DMX";

document.getElementById("dailyReward").innerHTML =
  ethers.utils.formatUnits(info[1],18) + " DMX";

document.getElementById("totalEarned").innerHTML =
  ethers.utils.formatUnits(info[2],18) + " DMX";

document.getElementById("directIncome").innerHTML =
  ethers.utils.formatUnits(info[3],18) + " DMX";

document.getElementById("levelIncome").innerHTML =
  ethers.utils.formatUnits(info[4],18) + " DMX";

/* ðŸ”¥ FIXED TEAM VOLUME */
document.getElementById("teamVolume").innerHTML =
  ethers.utils.formatUnits(info[5],18) + " DMX";

document.getElementById("claimable").value =
  ethers.utils.formatUnits(claimable,18) + " DMX";

/* Direct Volume */
document.getElementById("directVolume").innerHTML =
  ethers.utils.formatUnits(directVol,18) + " DMX";

}catch(e){
  console.log(e);
}
}

async function approveToken(){
try{
disable("approveBtn",true);
let amt=document.getElementById("amount").value;
if(!amt||isNaN(amt)) return alert("Invalid amount");

let token=document.getElementById("token").value==="USDT"?USDT:DMX;
let t=new ethers.Contract(token,ERC20_ABI,signer);
let tx=await t.approve(STAKING_ADDRESS,ethers.utils.parseUnits(amt,18));
await tx.wait();
alert("Approved");
}catch(e){alert(e.reason||e.message);}
disable("approveBtn",false);
}

async function stakeToken(){

  try{

    disable("stakeBtn", true);

    if(!provider){
      alert("Connect wallet first");
      disable("stakeBtn", false);
      return;
    }

    let amt = document.getElementById("amount").value;

    if(!amt || isNaN(amt) || Number(amt) <= 0){
      alert("Enter valid amount");
      disable("stakeBtn", false);
      return;
    }

    let tokenType = document.getElementById("token").value;

    // âœ… Minimum Validation
    if(tokenType === "USDT" && Number(amt) < 25){
      alert("Minimum stake is 25 USDT");
      disable("stakeBtn", false);
      return;
    }

    if(tokenType === "DMX" && Number(amt) < 5000){
      alert("Minimum stake is 5000 DMX");
      disable("stakeBtn", false);
      return;
    }

    let selectedDuration = document.getElementById("duration").value;

    if(!selectedDuration){
      alert("Please select duration");
      disable("stakeBtn", false);
      return;
    }

    // âœ… Convert days â†’ seconds
    let durationSeconds = Number(selectedDuration) * 86400;

    const signer = provider.getSigner();

    // âœ… Referral
    let ref = new URLSearchParams(window.location.search)
      .get("ref") || ethers.constants.AddressZero;

    const contract = new ethers.Contract(
      STAKING_ADDRESS,
      STAKE_ABI,
      signer
    );

    document.getElementById("status").innerHTML = "Staking...";

    let tx;

    if(tokenType === "USDT"){
      tx = await contract.stakeUSDT(
        ethers.utils.parseUnits(amt,18),
        durationSeconds,
        ref
      );
    } else {
      tx = await contract.stakeDMX(
        ethers.utils.parseUnits(amt,18),
        durationSeconds,
        ref
      );
    }

    await tx.wait();

    document.getElementById("status").innerHTML = "Stake Successful";

    alert("Stake Successful");

    loadData();

  } catch(e){

    console.log(e);
    alert(e.reason || e.message || "Stake Failed");

  }

  disable("stakeBtn", false);
}
  
async function claim(){
  try{

    disable("claimBtn", true);

    if(!provider){
      alert("Connect wallet first");
      disable("claimBtn", false);
      return;
    }

    const signer = provider.getSigner();
    const user = await signer.getAddress();

    const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);

    let reward = await c.getClaimable(user);

    let amount = Number(ethers.utils.formatUnits(reward,18));

    if(amount < 100){
      alert("Minimum 100 DMX required to claim");
      disable("claimBtn", false);
      return;
    }

    document.getElementById("status").innerHTML = "Claiming...";

    let tx = await c.claim();
    await tx.wait();

    document.getElementById("status").innerHTML = "Claim Successful";

    alert("Claim Successful");

    loadData();

  }catch(e){
    console.log(e);
    alert(e.reason || e.message || "Claim Failed");
  }

  disable("claimBtn", false);
}

async function restake(){
  try{

    disable("restakeBtn", true);

    if(!provider){
      alert("Connect wallet first");
      disable("restakeBtn", false);
      return;
    }

    const signer = provider.getSigner();
    const user = await signer.getAddress();

    const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);

    let claimable = await c.getClaimable(user);

    let amount = Number(ethers.utils.formatUnits(claimable,18));

    if(amount < 5000){
      alert("Minimum 5000 DMX required to Re-stake");
      disable("restakeBtn", false);
      return;
    }

    document.getElementById("status").innerHTML = "Restaking...";

    let tx = await c.restake();
    await tx.wait();

    document.getElementById("status").innerHTML = "Re-stake Successful";

    alert("Re-stake Successful");

    loadData();

  }catch(e){
    console.log(e);
    alert(e.reason || e.message || "Restake Failed");
  }

  disable("restakeBtn", false);
}

let levelUnlockInterval;

function updateLevelUnlockTimer(expiry){

  if(levelUnlockInterval) clearInterval(levelUnlockInterval);

  function tick(){

    const now = Math.floor(Date.now()/1000);
    const diff = Number(expiry) - now;

    if(diff <= 0){
      document.getElementById("levelUnlockRemaining").innerHTML = "Expired";
      return;
    }

    const days = Math.floor(diff / 86400);

    document.getElementById("levelUnlockRemaining").innerHTML =
      days + " Days";
  }

  tick();
  levelUnlockInterval = setInterval(tick,1000);
}
  
 async function loadLivePrice(){
  try{
    const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, provider);

    const price = await c.getDMXPrice();
    const manual = await c.manualPriceEnabled();

    const formatted = ethers.utils.formatUnits(price,18) + " USDT";

    // User side
    document.getElementById("livePriceUser").innerHTML = formatted;
    document.getElementById("priceModeUser").innerHTML =
      manual ? "Manual" : "Pancake Live";

    // Admin side
    document.getElementById("livePriceAdmin").innerHTML = formatted;
    document.getElementById("priceModeAdmin").innerHTML =
      manual ? "Manual" : "Pancake Live";

  }catch(e){
    console.log(e);
  }
  } 

/* ================= ADMIN FUNCTIONS ================= */

async function pauseStaking(){
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.pauseStaking()).wait();
  alert("Staking Paused");
}

async function unpauseStaking(){
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.unpauseStaking()).wait();
  alert("Staking Unpaused");
}

/* ===== PLAN RATE CONTROL ===== */

async function updatePlanRate(days){
  const percent = document.getElementById("rateInput"+days).value;
  if(!percent) return alert("Enter percent");

  const duration = days * 86400;
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);

  await (await c.setRewardRate(duration, percent)).wait();

  alert(days + " Days Rate Updated");
  loadRates();
}

async function loadRates(){
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, provider);

  const r90 = await c.rewardRates(90*86400);
  const r180 = await c.rewardRates(180*86400);
  const r365 = await c.rewardRates(365*86400);

  const p90 = (r90/100).toFixed(2);
  const p180 = (r180/100).toFixed(2);
  const p365 = (r365/100).toFixed(2);

  // Admin display
  document.getElementById("rate90").innerHTML = p90 + " %";
  document.getElementById("rate180").innerHTML = p180 + " %";
  document.getElementById("rate365").innerHTML = p365 + " %";

  // Stake dropdown auto update
  document.querySelector('#duration option[value="90"]').text =
    "90 Days - " + p90 + "% Daily";

  document.querySelector('#duration option[value="180"]').text =
    "180 Days - " + p180 + "% Daily";

  document.querySelector('#duration option[value="365"]').text =
    "365 Days - " + p365 + "% Daily";
}

/* ===== MINIMUM ===== */

async function updateMinUSDT(){
  const val = document.getElementById("minUSDT").value;
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.setMinimumUSDT(ethers.utils.parseUnits(val,18))).wait();
  alert("USDT Minimum Updated");
}

async function updateMinDMX(){
  const val = document.getElementById("minDMX").value;
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.setMinimumDMX(ethers.utils.parseUnits(val,18))).wait();
  alert("DMX Minimum Updated");
}

/* ===== EMERGENCY ===== */

async function emergencyWithdraw(){
  const tokenType = document.getElementById("withdrawToken").value;
  const amt = document.getElementById("withdrawAmount").value;
  const tokenAddress = tokenType==="USDT"?USDT:DMX;

  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);

  await (await c.emergencyWithdrawToken(
    tokenAddress,
    ethers.utils.parseUnits(amt,18)
  )).wait();

  alert("Withdraw Completed");
}

/* ===== TREASURY ===== */

async function updateTreasury(){
  const addr = document.getElementById("newTreasury").value;
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.setTreasury(addr)).wait();
  alert("Treasury Updated");
}

/* ===== OWNERSHIP ===== */

async function transferOwner(){
  const addr = document.getElementById("newOwner").value;
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.transferOwnership(addr)).wait();
  alert("Ownership Transferred");
}

/* ===== DIRECT & LEVEL ===== */

async function updateDirect(){
  const val = document.getElementById("directPercent").value;
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.setDirectPercent(val)).wait();
  alert("Direct Percent Updated");
}

async function updateLevel(){
  const level = document.getElementById("levelNumber").value;
  const percent = document.getElementById("levelPercent").value;
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.setLevelPercent(level, percent)).wait();
  alert("Level Percent Updated");
}

/* ===== DMX PRICE ===== */

async function togglePriceMode(){

  const mode =
    document.getElementById("priceMode").value === "true";

  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);

  await (await c.toggleManualPrice(mode)).wait();

  alert("Price Mode Updated");

  await loadLivePrice(); // ðŸ”¥ added
}

/* ================= END ADMIN ================= */
  
async function openDownline(){

  if(!provider || !userAddress){
    alert("Connect wallet first");
    return;
  }

  document.getElementById("downlinePopup").style.display="flex";

  try{

    const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, provider);

    let html="";

    for(let level=1; level<=25; level++){

      const count = await c.getLevelCount(userAddress, level);

      if(count > 0){

        html += `
        <div style="margin-top:15px;color:gold">
          Level ${level} (Total: ${count})
        </div>`;

        const users = await c.getLevelUsers(userAddress, level);

        users.forEach(u => {

          const wallet = u[0];
          const amount = ethers.utils.formatUnits(u[1],18);
          const date = new Date(Number(u[2]) * 1000).toLocaleString();

          html += `
          <div style="border-bottom:1px solid #333;padding:8px 0">
            <small>${wallet}</small><br>
            Stake: ${amount} DMX<br>
            Joined: ${date}
          </div>`;
        });
      }
    }

    document.getElementById("downlineData").innerHTML =
      html || "No downline history found.";

  }catch(e){

    console.log(e);

    document.getElementById("downlineData").innerHTML =
      "Unable to load downline history.";

  }
}
  
async function openHistory(){

  if(!provider || !userAddress){
    alert("Connect wallet first");
    return;
  }

  document.getElementById("historyPopup").style.display="flex";

  try{

    const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, provider);

    const filter = c.filters.Claimed(userAddress);

    const events = await c.queryFilter(filter);

    let html = "";

    if(events.length === 0){
      html = "No claim history found";
    }else{

      events.reverse().forEach(e=>{

        const amount =
          ethers.utils.formatUnits(e.args.amount,18);

        const timestamp = Number(e.args.time);

        const date =
          new Date(timestamp * 1000).toLocaleString();

        const txHash = e.transactionHash;

        html += `
        <div style="
          border-bottom:1px solid #333;
          padding:12px 0;
          line-height:1.6;
        ">
          <strong style="color:gold;">
            ${amount} DMX
          </strong><br>

          <small>
            Date: ${date}
          </small><br>

          <small>
            Tx:
            <a href="https://bscscan.com/tx/${txHash}"
               target="_blank"
               style="color:#ffd700;text-decoration:none;">
               View on BscScan
            </a>
          </small>
        </div>
        `;
      });
    }

    document.getElementById("historyData").innerHTML = html;

  }catch(e){

    console.log(e);

    document.getElementById("historyData").innerHTML =
      "Unable to fetch claim history";

  }
}

async function openStakeHistory(){

  if(!provider || !userAddress){
    alert("Connect wallet first");
    return;
  }

  document.getElementById("stakeHistoryPopup").style.display="flex";

  try{

    const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, provider);

    const count = await c.getStakeCount(userAddress);

    let html = "";

    for(let i=0; i<count; i++){

      const data = await c.getStakeInfo(userAddress, i);

      const amount = ethers.utils.formatUnits(data[0],18);
      const startDate = new Date(data[1]*1000).toLocaleDateString();
      const expiryDate = new Date(data[2]*1000).toLocaleDateString();

      html += `
      <div style="border-bottom:1px solid #333;padding:10px 0">
        <strong>Amount:</strong> ${amount} DMX<br>
        <strong>Start:</strong> ${startDate}<br>
        <strong>Expiry:</strong> ${expiryDate}
      </div>
      `;
    }

    document.getElementById("stakeHistoryData").innerHTML =
      html || "No stake history found";

  }catch(e){

    console.log(e);

    document.getElementById("stakeHistoryData").innerHTML =
      "Contract not deployed or function not available";

  }
}

function closePopup(){
document.getElementById("downlinePopup").style.display="none";
document.getElementById("historyPopup").style.display="none";
document.getElementById("stakeHistoryPopup").style.display="none";  
}
  
function copyRef(){
navigator.clipboard.writeText(document.getElementById("refLink").value);
alert("Copied");
}

function viewAddress(addr){
if(!addr||addr.includes("PUT")) return alert("Address not set");
window.open("https://bscscan.com/address/"+addr,"_blank");
}

</script>

</body>
</html>
