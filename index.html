<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DimeX Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
<script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

<style>
*{box-sizing:border-box}
body{
margin:0;
font-family:Poppins;
background:#000;
color:#fff;
}

.topbar{
display:flex;
justify-content:space-between;
align-items:center;
padding:18px 25px;
background:#0b0b0b;
border-bottom:1px solid #222;
}

.logoWrap{
display:flex;
align-items:center;
gap:12px;
}

.logoWrap img{width:45px}

.logoText{
color:gold;
font-size:22px;
font-weight:600;
letter-spacing:1px;
}

.connectBtn{
background:linear-gradient(90deg,#ffd700,#ffb700);
color:#000;
border:none;
padding:12px 22px;
border-radius:10px;
font-weight:bold;
cursor:pointer;
font-size:14px;
}

.container{
max-width:1250px;
margin:auto;
padding:30px 20px;
}

#walletDisplay{
margin-bottom:20px;
color:gold;
font-size:14px;
}
  
.stats{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
gap:20px;
margin-bottom:35px;
}

.stat{
background:#111;
border:1px solid rgba(255,215,0,0.35);
border-radius:18px;
padding:25px;
text-align:center;
}

.stat i{
color:gold;
font-size:22px;
margin-bottom:8px;
display:block;
}

.stat span{
display:block;
margin-top:8px;
font-size:22px;
font-weight:600;
color:gold;
}

.grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:25px;
margin-bottom:30px;
}

.card{
background:#111;
border:1px solid rgba(255,215,0,0.35);
padding:28px;
border-radius:18px;
}

h3{
margin-top:0;
color:gold;
font-weight:600;
}

h3 i{
  margin-right:8px;
  color:gold;
}
  
input,select{
width:100%;
padding:14px;
background:#000;
border:1px solid #333;
color:#fff;
border-radius:10px;
margin-top:12px;
font-size:14px;
}

button{
padding:14px;
border:none;
border-radius:10px;
background:gold;
font-weight:bold;
cursor:pointer;
width:100%;
margin-top:14px;
font-size:14px;
}

button:disabled{
opacity:0.6;
cursor:not-allowed;
}

.contractRow{
display:flex;
justify-content:space-between;
align-items:center;
background:#000;
padding:14px;
margin:10px 0;
border-radius:10px;
border:1px solid #222;
}

.contractRow button{
width:auto;
padding:8px 16px;
margin:0;
}

.popup{
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.85);
display:none;
align-items:center;
justify-content:center;
z-index:9999;
}

.popupBox{
background:#111;
padding:30px;
border-radius:18px;
width:92%;
max-width:550px;
max-height:80vh;
overflow:auto;
border:1px solid #222;
}

.adminPanel{display:none;margin-top:20px}

@media(max-width:600px){

/* Logo smaller */
.logoWrap img{
  width:32px;
}

.logoText{
  font-size:18px;
}

/* Stats single column */
.stats{
  grid-template-columns:1fr;
  gap:10px;
}

/* Smaller stat box */
.stat{
  padding:12px;
  border-radius:14px;
}

.stat i{
  font-size:16px;
}

.stat span{
  font-size:16px;
}

/* Cards single column */
.grid{
  grid-template-columns:1fr;
  gap:15px;
}

/* Smaller cards */
.card{
  padding:16px;
  border-radius:14px;
}

input,select{
  padding:10px;
  font-size:13px;
}

button{
  padding:12px;
  font-size:13px;
}

}
</style>
</head>

<body>

<div class="topbar">
<div class="logoWrap">
<img src="https://i.ibb.co/HpqwGFqt/logo.png">
<div class="logoText">DimeX Dashboard</div>
</div>
<button class="connectBtn" onclick="connectWallet()">Connect Wallet</button>
</div>

<div class="container">

<div id="walletDisplay"></div>
<div id="status" style="margin-bottom:15px;color:gold;"></div>  

<div class="stats">
<div class="stat"><i class="fa-solid fa-wallet"></i>Total Stake<span id="totalStake">0</span></div>
<div class="stat"><i class="fa-solid fa-bolt"></i>Daily Reward<span id="dailyReward">0</span></div>
<div class="stat"><i class="fa-solid fa-chart-line"></i>Total Earned<span id="totalIncome">0</span></div>
<div class="stat"><i class="fa-solid fa-user-plus"></i>Direct Income<span id="directIncome">0</span></div>
<div class="stat"><i class="fa-solid fa-sitemap"></i>Level Income<span id="levelIncome">0</span></div>
<div class="stat"><i class="fa-solid fa-users"></i>Team Count<span id="teamCount">0</span></div>
</div>

<div class="grid">

<div class="card">
<h3><i class="fa-solid fa-coins"></i> Stake</h3>
<select id="token">
<option value="USDT">USDT BEP20</option>
<option value="DMX">DMX</option>
</select>
<input id="amount" placeholder="Enter amount">
<select id="duration">
<option value="" disabled selected>Select Duration</option>
<option value="90">90 Days (0.20%)</option>
<option value="180">180 Days (0.25%)</option>
<option value="365">365 Days (0.30%)</option>
</select>
<button id="approveBtn" onclick="approveToken()">Approve</button>
<button id="stakeBtn" onclick="stakeToken()">Stake</button>
</div>
  
<div class="card">
<h3><i class="fa-solid fa-gift"></i> Claim</h3>
<input id="claimable" readonly>
  
<div style="margin-top:10px;font-size:13px;color:#aaa;">
‚è≥ Lock Ends In:
<span id="remainingTime" style="color:gold;">--</span>
</div>
  
<button id="claimBtn" onclick="claim()">Claim</button>
<button id="restakeBtn" onclick="restake()">Restake</button>
</div>

<div class="card">
<h3><i class="fa-solid fa-link"></i> Referral</h3>
<input id="refLink" readonly>
<button onclick="copyRef()">Copy Link</button>
</div>

<div class="card">
<h3><i class="fa-solid fa-sitemap"></i> Team</h3>
<button onclick="openDownline()">View Downline</button>
<button onclick="openHistory()">Claim History</button>
</div>

</div>

<div class="card">
<h3><i class="fa-solid fa-network-wired"></i> Ecosystem</h3>
  
 <div style="margin-bottom:15px;font-size:14px;color:#aaa;">
üî• Live DMX Price:
<span id="livePriceUser" style="color:gold;">--</span><br>
Mode:
<span id="priceModeUser" style="color:gold;">--</span>
 </div> 
  
<div class="contractRow"><span>DMX Token</span><button onclick="viewAddress(DMX)">View</button></div>
<div class="contractRow"><span>Staking</span><button onclick="viewAddress(STAKING_ADDRESS)">View</button></div>
<div class="contractRow"><span>LP Pair</span><button onclick="viewAddress(LP)">View</button></div>
<div class="contractRow"><span>Router</span><button onclick="viewAddress(ROUTER)">View</button></div>
</div>
  
<!-- ================= ADMIN PANEL START ================= -->
<div class="adminPanel" id="adminPanel">
  <div class="card">

    <div style="
      background:#111;
      border:1px solid gold;
      padding:8px 12px;
      border-radius:8px;
      margin-bottom:15px;
      color:gold;
      font-size:13px;">
      ‚úî Admin Wallet Connected
    </div>

    <h3>
      <i class="fa-solid fa-user-shield"></i>
      Full Admin Control Panel
    </h3>

<!-- üî• LIVE PRICE DISPLAY -->
<div style="margin-bottom:15px;color:#aaa;font-size:14px;">
üî• Current DMX Price:
<span id="livePriceAdmin" style="color:gold;">--</span><br>
Mode:
<span id="priceModeAdmin" style="color:gold;">--</span>
</div>
    
    <!-- Pause -->
    <button onclick="pauseStaking()">Pause Staking</button>
    <button onclick="unpauseStaking()">Unpause Staking</button>

    <hr style="margin:20px 0;border-color:#333;">

    <!-- ===== PLAN REWARD RATES ===== -->
    <h4 style="color:gold;">Plan Reward Rates</h4>

    <div>
      90 Days Current: <span id="rate90" style="color:gold;">--</span>
    </div>
    <input id="rateInput90" placeholder="New % for 90 Days">
    <button onclick="updatePlanRate(90)">Update 90 Days</button>

    <hr style="margin:15px 0;border-color:#222;">

    <div>
      180 Days Current: <span id="rate180" style="color:gold;">--</span>
    </div>
    <input id="rateInput180" placeholder="New % for 180 Days">
    <button onclick="updatePlanRate(180)">Update 180 Days</button>

    <hr style="margin:15px 0;border-color:#222;">

    <div>
      365 Days Current: <span id="rate365" style="color:gold;">--</span>
    </div>
    <input id="rateInput365" placeholder="New % for 365 Days">
    <button onclick="updatePlanRate(365)">Update 365 Days</button>

    <hr style="margin:20px 0;border-color:#333;">

    <!-- Minimum Stake -->
    <h4 style="color:gold;">Update Minimum Stake</h4>
    <input id="minUSDT" placeholder="New Minimum USDT">
    <button onclick="updateMinUSDT()">Update USDT</button>

    <input id="minDMX" placeholder="New Minimum DMX">
    <button onclick="updateMinDMX()">Update DMX</button>

    <hr style="margin:20px 0;border-color:#333;">

    <!-- Emergency Withdraw -->
    <h4 style="color:gold;">Emergency Withdraw</h4>
    <select id="withdrawToken">
      <option value="USDT">USDT</option>
      <option value="DMX">DMX</option>
    </select>
    <input id="withdrawAmount" placeholder="Amount">
    <button onclick="emergencyWithdraw()">Withdraw</button>

    <hr style="margin:20px 0;border-color:#333;">

    <!-- Treasury -->
    <h4 style="color:gold;">Change Treasury Wallet</h4>
    <input id="newTreasury" placeholder="New Treasury Address">
    <button onclick="updateTreasury()">Update Treasury</button>

    <hr style="margin:20px 0;border-color:#333;">

    <!-- Ownership -->
    <h4 style="color:gold;">Transfer Ownership</h4>
    <input id="newOwner" placeholder="New Owner Address">
    <button onclick="transferOwner()">Transfer Ownership</button>

    <hr style="margin:20px 0;border-color:#333;">

    <!-- Direct & Level -->
    <h4 style="color:gold;">Update Direct Bonus %</h4>
    <input id="directPercent" placeholder="New Direct Percent">
    <button onclick="updateDirect()">Update Direct</button>

    <h4 style="color:gold;margin-top:15px;">Update Level Bonus %</h4>
    <input id="levelNumber" placeholder="Level (1-20)">
    <input id="levelPercent" placeholder="New Percent">
    <button onclick="updateLevel()">Update Level</button>

    <hr style="margin:20px 0;border-color:#333;">

    <!-- DMX Price -->
    <h4 style="color:gold;">DMX Price Control</h4>
    <input id="manualPrice" placeholder="DMX price in USDT (0.25)">
    <button onclick="setManualPrice()">Set Manual Price</button>

    <select id="priceMode">
      <option value="true">Enable Manual Price</option>
      <option value="false">Use Live Pancake Price</option>
    </select>
    <button onclick="togglePriceMode()">Update Price Mode</button>

  </div>
</div>
<!-- ================= ADMIN PANEL END ================= -->
  
<div class="popup" id="downlinePopup">
<div class="popupBox">
<h3>20 Level Downline</h3>
<div id="downlineData"></div>
<button onclick="closePopup()">Close</button>
</div>
</div>

<div class="popup" id="historyPopup">
<div class="popupBox">
<h3>Claim History</h3>
<div id="historyData"></div>
<button onclick="closePopup()">Close</button>
</div>
</div>

<script>

let provider, signer, userAddress;

const ADMIN="0x53ba2d865be750d0e2d4d01bcb0a46ec1684c46b";
const USDT="0x55d398326f99059fF775485246999027B3197955";
const DMX="PUT_DMX_TOKEN";
const STAKING_ADDRESS="PUT_STAKING_CONTRACT";
const LP="PUT_LP_ADDRESS";
const ROUTER="0x10ED43C718714eb63d5aA57B78B54704E256024E";

const ERC20_ABI=[
  "function approve(address,uint256) external returns(bool)"
];

const STAKE_ABI = [

  // ===== USER =====
  "function stakeUSDT(uint256,uint256,address) external",
  "function stakeDMX(uint256,uint256,address) external",
  "function claim() external",
  "function restake() external",

  /* ===== OPTIONAL SEPARATE VIEW FUNCTIONS ===== */
"function totalStakeOf(address) view returns(uint256)",
"function dailyRewardOf(address) view returns(uint256)",
"function totalEarnedOf(address) view returns(uint256)",
"function directIncomeOf(address) view returns(uint256)",
"function levelIncomeOf(address) view returns(uint256)",
"function teamCountOf(address) view returns(uint256)",

  // ===== PRICE SYSTEM =====
  "function getDMXPrice() view returns(uint256)",
  "function manualPriceEnabled() view returns(bool)",
  "function setManualPrice(uint256) external",
  "function toggleManualPrice(bool) external",

  // ===== ADMIN CONTROL =====
  "function pauseStaking() external",
  "function unpauseStaking() external",

  // ===== REWARD RATE =====
  "function setRewardRate(uint256,uint256) external",
  "function rewardRates(uint256) view returns(uint256)",

  // ===== MINIMUM =====
  "function setMinimumUSDT(uint256) external",
  "function setMinimumDMX(uint256) external",

  // ===== EMERGENCY =====
  "function emergencyWithdrawToken(address,uint256) external",

  // ===== TREASURY & OWNERSHIP =====
  "function setTreasury(address) external",
  "function transferOwnership(address) external",

  // ===== REFERRAL =====
  "function setDirectPercent(uint256) external",
  "function setLevelPercent(uint256,uint256) external",

  // ===== USER INFO =====
  "function getUserInfo(address) view returns(uint256,uint256,uint256,uint256,uint256,uint256)",
  "function getClaimable(address) view returns(uint256)",
  "function getLevelCount(address,uint256) view returns(uint256)",
  "function getUnlockTime(address) view returns(uint256)",

  // ===== EVENTS =====
  "event Claimed(address indexed user,uint256 amount,uint256 time)"
];
  
function disable(id,state){document.getElementById(id).disabled=state;}
function seconds(d){return Number(d)*86400;}

async function connectWallet(){
try{
if(window.ethereum){
provider=new ethers.providers.Web3Provider(window.ethereum);
await provider.send("eth_requestAccounts",[]);
}else{
const wc=new WalletConnectProvider.default({rpc:{56:"https://bsc-dataseed.binance.org/"}});
await wc.enable();
provider=new ethers.providers.Web3Provider(wc);
}
const network=await provider.getNetwork();
if(network.chainId!==56){alert("Switch to BSC Mainnet");return;}
signer=provider.getSigner();
userAddress=await signer.getAddress();

document.getElementById("walletDisplay").innerHTML="Connected: "+userAddress;
document.getElementById("refLink").value=window.location.origin+"?ref="+userAddress;

if(userAddress.toLowerCase()===ADMIN.toLowerCase()){
document.getElementById("adminPanel").style.display="block";
}

await loadData();
    await loadLivePrice();
    setInterval(loadLivePrice,10000);

}catch(e){alert(e.message);}
}

async function loadData(){
try{
const c=new ethers.Contract(STAKING_ADDRESS,STAKE_ABI,provider);
const info=await c.getUserInfo(userAddress);
const claimable=await c.getClaimable(userAddress);
  
// üî• ADD THIS HERE
const unlockTime = await c.getUnlockTime(userAddress);
startTimer(unlockTime);
  
document.getElementById("totalStake").innerHTML=ethers.utils.formatUnits(info[0],18);
document.getElementById("dailyReward").innerHTML=ethers.utils.formatUnits(info[1],18);
document.getElementById("totalIncome").innerHTML=ethers.utils.formatUnits(info[2],18);
document.getElementById("directIncome").innerHTML=ethers.utils.formatUnits(info[3],18);
document.getElementById("levelIncome").innerHTML=ethers.utils.formatUnits(info[4],18);
document.getElementById("teamCount").innerHTML=info[5];
document.getElementById("claimable").value=ethers.utils.formatUnits(claimable,18);
}catch(e){console.log(e);}
}

async function approveToken(){
try{
disable("approveBtn",true);
let amt=document.getElementById("amount").value;
if(!amt||isNaN(amt)) return alert("Invalid amount");

let token=document.getElementById("token").value==="USDT"?USDT:DMX;
let t=new ethers.Contract(token,ERC20_ABI,signer);
let tx=await t.approve(STAKING_ADDRESS,ethers.utils.parseUnits(amt,18));
await tx.wait();
alert("Approved");
}catch(e){alert(e.reason||e.message);}
disable("approveBtn",false);
}

async function stakeToken(){

  try{

    disable("stakeBtn", true);

    if(!provider){
      alert("Connect wallet first");
      disable("stakeBtn", false);
      return;
    }

    let amt = document.getElementById("amount").value;

    if(!amt || isNaN(amt) || Number(amt) <= 0){
      alert("Enter valid amount");
      disable("stakeBtn", false);
      return;
    }

    let tokenType = document.getElementById("token").value;

    // ‚úÖ Minimum Validation
    if(tokenType === "USDT" && Number(amt) < 25){
      alert("Minimum stake is 25 USDT");
      disable("stakeBtn", false);
      return;
    }

    if(tokenType === "DMX" && Number(amt) < 5000){
      alert("Minimum stake is 5000 DMX");
      disable("stakeBtn", false);
      return;
    }

    let selectedDuration = document.getElementById("duration").value;

    if(!selectedDuration){
      alert("Please select duration");
      disable("stakeBtn", false);
      return;
    }

    // ‚úÖ Convert days ‚Üí seconds
    let durationSeconds = Number(selectedDuration) * 86400;

    const signer = provider.getSigner();

    // ‚úÖ Referral
    let ref = new URLSearchParams(window.location.search)
      .get("ref") || ethers.constants.AddressZero;

    const contract = new ethers.Contract(
      STAKING_ADDRESS,
      STAKE_ABI,
      signer
    );

    document.getElementById("status").innerHTML = "Staking...";

    let tx;

    if(tokenType === "USDT"){
      tx = await contract.stakeUSDT(
        ethers.utils.parseUnits(amt,18),
        durationSeconds,
        ref
      );
    } else {
      tx = await contract.stakeDMX(
        ethers.utils.parseUnits(amt,18),
        durationSeconds,
        ref
      );
    }

    await tx.wait();

    document.getElementById("status").innerHTML = "Stake Successful";

    alert("Stake Successful");

    loadData();

  } catch(e){

    console.log(e);
    alert(e.reason || e.message || "Stake Failed");

  }

  disable("stakeBtn", false);
}
  
async function claim(){
  try{

    disable("claimBtn", true);

    if(!provider){
      alert("Connect wallet first");
      disable("claimBtn", false);
      return;
    }

    const signer = provider.getSigner();
    const user = await signer.getAddress();

    const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);

    let reward = await c.getClaimable(user);

    let amount = Number(ethers.utils.formatUnits(reward,18));

    if(amount < 100){
      alert("Minimum 100 DMX required to claim");
      disable("claimBtn", false);
      return;
    }

    document.getElementById("status").innerHTML = "Claiming...";

    let tx = await c.claim();
    await tx.wait();

    document.getElementById("status").innerHTML = "Claim Successful";

    alert("Claim Successful");

    loadData();

  }catch(e){
    console.log(e);
    alert(e.reason || e.message || "Claim Failed");
  }

  disable("claimBtn", false);
}

async function restake(){
  try{

    disable("restakeBtn", true);

    if(!provider){
      alert("Connect wallet first");
      disable("restakeBtn", false);
      return;
    }

    const signer = provider.getSigner();
    const user = await signer.getAddress();

    const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);

    let claimable = await c.getClaimable(user);

    let amount = Number(ethers.utils.formatUnits(claimable,18));

    if(amount < 5000){
      alert("Minimum 5000 DMX required to Re-stake");
      disable("restakeBtn", false);
      return;
    }

    document.getElementById("status").innerHTML = "Restaking...";

    let tx = await c.restake();
    await tx.wait();

    document.getElementById("status").innerHTML = "Re-stake Successful";

    alert("Re-stake Successful");

    loadData();

  }catch(e){
    console.log(e);
    alert(e.reason || e.message || "Restake Failed");
  }

  disable("restakeBtn", false);
}
  
// üëáüëáüëá PLACE TIMER CODE HERE üëáüëáüëá

let timerInterval;

function startTimer(unlockTimestamp){

  if(timerInterval) clearInterval(timerInterval);

  function update(){

    const now = Math.floor(Date.now()/1000);
    const diff = unlockTimestamp - now;

    if(diff <= 0){
      document.getElementById("remainingTime").innerHTML = "Unlocked";
      clearInterval(timerInterval);
      return;
    }

    const days = Math.floor(diff / 86400);
    const hours = Math.floor((diff % 86400) / 3600);
    const minutes = Math.floor((diff % 3600) / 60);
    const seconds = diff % 60;

    document.getElementById("remainingTime").innerHTML =
      days+"D "+hours+"H "+minutes+"M "+seconds+"S";
  }

  update();
  timerInterval = setInterval(update,1000);
}

// üëÜüëÜüëÜ TIMER CODE END üëÜüëÜüëÜ

/* ================= ADMIN FUNCTIONS ================= */

async function pauseStaking(){
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.pauseStaking()).wait();
  alert("Staking Paused");
}

async function unpauseStaking(){
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.unpauseStaking()).wait();
  alert("Staking Unpaused");
}

/* ===== PLAN RATE CONTROL ===== */

async function updatePlanRate(days){
  const percent = document.getElementById("rateInput"+days).value;
  if(!percent) return alert("Enter percent");

  const duration = days * 86400;
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);

  await (await c.setRewardRate(duration, percent)).wait();

  alert(days + " Days Rate Updated");
  loadRates();
}

async function loadRates(){
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, provider);

  const r90 = await c.rewardRates(90*86400);
  const r180 = await c.rewardRates(180*86400);
  const r365 = await c.rewardRates(365*86400);

  document.getElementById("rate90").innerHTML = r90 + " %";
  document.getElementById("rate180").innerHTML = r180 + " %";
  document.getElementById("rate365").innerHTML = r365 + " %";
}

/* ===== MINIMUM ===== */

async function updateMinUSDT(){
  const val = document.getElementById("minUSDT").value;
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.setMinimumUSDT(ethers.utils.parseUnits(val,18))).wait();
  alert("USDT Minimum Updated");
}

async function updateMinDMX(){
  const val = document.getElementById("minDMX").value;
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.setMinimumDMX(ethers.utils.parseUnits(val,18))).wait();
  alert("DMX Minimum Updated");
}

/* ===== EMERGENCY ===== */

async function emergencyWithdraw(){
  const tokenType = document.getElementById("withdrawToken").value;
  const amt = document.getElementById("withdrawAmount").value;
  const tokenAddress = tokenType==="USDT"?USDT:DMX;

  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);

  await (await c.emergencyWithdrawToken(
    tokenAddress,
    ethers.utils.parseUnits(amt,18)
  )).wait();

  alert("Withdraw Completed");
}

/* ===== TREASURY ===== */

async function updateTreasury(){
  const addr = document.getElementById("newTreasury").value;
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.setTreasury(addr)).wait();
  alert("Treasury Updated");
}

/* ===== OWNERSHIP ===== */

async function transferOwner(){
  const addr = document.getElementById("newOwner").value;
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.transferOwnership(addr)).wait();
  alert("Ownership Transferred");
}

/* ===== DIRECT & LEVEL ===== */

async function updateDirect(){
  const val = document.getElementById("directPercent").value;
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.setDirectPercent(val)).wait();
  alert("Direct Percent Updated");
}

async function updateLevel(){
  const level = document.getElementById("levelNumber").value;
  const percent = document.getElementById("levelPercent").value;
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);
  await (await c.setLevelPercent(level, percent)).wait();
  alert("Level Percent Updated");
}

/* ===== DMX PRICE ===== */

async function togglePriceMode(){

  const mode =
    document.getElementById("priceMode").value === "true";

  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);

  await (await c.toggleManualPrice(mode)).wait();

  alert("Price Mode Updated");

  await loadLivePrice(); // üî• added
}

async function togglePriceMode(){
  const mode = document.getElementById("priceMode").value==="true";
  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, signer);

  await (await c.toggleManualPrice(mode)).wait();

  alert("Price Mode Updated");
}

/* ================= END ADMIN ================= */
  
async function openDownline(){

  const c=new ethers.Contract(STAKING_ADDRESS,STAKE_ABI,provider);

  let html="";

  for(let i=1;i<=20;i++){

    const count = await c.getLevelCount(userAddress,i);

    html+=`
    <div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #333">
      <span>Level ${i}</span>
      <span>${count}</span>
    </div>`;
  }

  document.getElementById("downlineData").innerHTML=html;
  document.getElementById("downlinePopup").style.display="flex";
}

async function loadLivePrice(){

  if(!provider) return;

  const c = new ethers.Contract(STAKING_ADDRESS, STAKE_ABI, provider);

  try{

    const price = await c.getDMXPrice();
    const manual = await c.manualPriceEnabled();

    const formatted =
      ethers.utils.formatUnits(price,18) + " USDT";

    const mode =
      manual ? "Manual Mode" : "Pancake Live";

    // Admin display
    if(document.getElementById("livePriceAdmin"))
      document.getElementById("livePriceAdmin").innerHTML = formatted;

    if(document.getElementById("priceModeAdmin"))
      document.getElementById("priceModeAdmin").innerHTML = mode;

    // User display (if exists)
    if(document.getElementById("livePriceUser"))
      document.getElementById("livePriceUser").innerHTML = formatted;

    if(document.getElementById("priceModeUser"))
      document.getElementById("priceModeUser").innerHTML = mode;

  }catch(e){
    console.log("Price Load Error:",e);
  }
  
async function openHistory(){
document.getElementById("historyPopup").style.display="flex";
try{
const c=new ethers.Contract(STAKING_ADDRESS,STAKE_ABI,provider);
const f=c.filters.Claimed(userAddress);
const ev=await c.queryFilter(f,-5000);
let html="";
ev.reverse().forEach(e=>{
let amount=ethers.utils.formatUnits(e.args.amount,18);
let time=new Date(e.args.time*1000).toLocaleString();
html+=`<div style="border-bottom:1px solid #333;padding:8px 0">
${amount} DMX<br><small>${time}</small></div>`;
});
document.getElementById("historyData").innerHTML=html||"No history found";
}catch{
document.getElementById("historyData").innerHTML="Unable to fetch history";
}
}

function closePopup(){
document.getElementById("downlinePopup").style.display="none";
document.getElementById("historyPopup").style.display="none";
}

function copyRef(){
navigator.clipboard.writeText(document.getElementById("refLink").value);
alert("Copied");
}

function viewAddress(addr){
if(!addr||addr.includes("PUT")) return alert("Address not set");
window.open("https://bscscan.com/address/"+addr,"_blank");
}

</script>

</body>
</html>
